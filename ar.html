<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>AR Graffiti - A-Frame</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        /* O bot√£o de AR √© gerado automaticamente pelo A-Frame */
        .a-enter-ar-button {
            bottom: 20px !important; top: unset !important;
            left: 50% !important; transform: translateX(-50%) !important;
            background-color: #007aff !important; border-radius: 30px !important;
            position: fixed !important; z-index: 10000 !important;
        }
        #ui-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }
        .hidden { display: none; }
        /* UI do desenho */
        #drawing-ui { background: rgba(0,0,0,0.45); padding: 10px; border-radius: 8px; display: flex; gap: 15px; align-items: center; pointer-events: auto; }
        label { color: white; font-size: 13px; }
        input[type=color] { width:40px; height:28px; padding:0; border:0; }
        input[type=range] { width:120px; }
        #btnLogout { position: fixed; top: 10px; right: 10px; z-index: 10000; pointer-events: auto; padding: 8px 12px; }
        #toggle-draw-btn {
            position: fixed; bottom: 20px; right: 20px; background-color: #00aaff; color: #fff; border: none;
            border-radius: 50%; width: 60px; height: 60px; font-size: 32px; line-height: 60px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,.4); cursor: pointer; pointer-events: auto;
        }
    </style>
</head>
<body>
    <a-scene id="ar-scene"
        webxr="requiredFeatures: hit-test;"
        vr-mode-ui="enabled: false"
        renderer="colorManagement: true">
        
        <a-assets>
            <canvas id="paint-canvas" width="512" height="512" crossorigin="anonymous"></canvas>
        </a-assets>
        
        <a-camera></a-camera>
        <a-entity cursor="rayOrigin: mouse;" raycaster="objects: [ar-plane];"></a-entity>
        
        <a-entity id="reticle"
            ar-hit-test="target: #reticle-plane"
            visible="false">
            <a-plane id="reticle-plane" position="0 0 0" width="1" height="1" material="src: none" visible="false"></a-plane>
            <a-ring color="#007aff" radius-inner="0.15" radius-outer="0.2" rotation="-90 0 0"></a-ring>
        </a-entity>
    </a-scene>

    <div id="ui-overlay">
        <button id="btnLogout">Sair</button>
        <button id="toggle-draw-btn" class="hidden">üñåÔ∏è</button>
        <div id="drawing-ui" class="hidden">
            <label>Cor:</label>
            <input id="colorPicker" type="color" value="#ff0000" />
            <label>Espessura:</label>
            <input id="thickness" type="range" min="1" max="30" value="10" />
            <button id="btnClear">Limpar</button>
            <button id="btnPlaceArt">Posicionar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = { /* ... Seus dados do Firebase ... */ };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const sceneEl = document.querySelector('a-scene');
        const reticle = document.getElementById('reticle');
        const toggleDrawBtn = document.getElementById('toggle-draw-btn');
        const drawingUI = document.getElementById('drawingUI');
        const paintCanvas = document.getElementById('paint-canvas');
        const ctx = paintCanvas.getContext('2d');
        let currentArtTexture = null;

        // --- GUARDA DE AUTENTICA√á√ÉO ---
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
            }
        });

        document.getElementById('btnLogout').addEventListener('click', () => auth.signOut());

        // --- L√ìGICA DA SESS√ÉO AR ---
        sceneEl.addEventListener('enter-vr', () => {
            toggleDrawBtn.classList.remove('hidden');
            loadArts();
        });

        // --- L√ìGICA DE DESENHO E UI ---
        toggleDrawBtn.addEventListener('click', () => {
            // Cria um canvas 2D tempor√°rio para desenhar
            const tempCanvas = document.createElement('canvas');
            tempCanvas.id = 'temp-drawing-canvas';
            tempCanvas.style.cssText = 'position: fixed; top: 0; left: 0; z-index: 10001; touch-action: none;';
            document.body.appendChild(tempCanvas);

            drawingUI.classList.remove('hidden');
            toggleDrawBtn.classList.add('hidden');
            
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = window.innerWidth;
            tempCanvas.height = window.innerHeight;

            let drawing = false;
            const start = (e) => { drawing = true; draw(e); };
            const stop = () => { drawing = false; tempCtx.beginPath(); };
            const draw = (e) => {
                if(!drawing) return; e.preventDefault();
                const rect = tempCanvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                tempCtx.lineWidth = document.getElementById('thickness').value;
                tempCtx.lineCap = 'round';
                tempCtx.strokeStyle = document.getElementById('colorPicker').value;
                tempCtx.lineTo(x, y);
                tempCtx.stroke(); tempCtx.beginPath(); tempCtx.moveTo(x, y);
            };
            tempCanvas.addEventListener('mousedown', start); tempCanvas.addEventListener('mouseup', stop); tempCanvas.addEventListener('mousemove', draw);
            tempCanvas.addEventListener('touchstart', start, {passive: false}); tempCanvas.addEventListener('touchend', stop); tempCanvas.addEventListener('touchmove', draw, {passive: false});

            document.getElementById('btnClear').onclick = () => tempCtx.clearRect(0,0,tempCanvas.width, tempCanvas.height);
            
            document.getElementById('btnPlaceArt').onclick = () => {
                // Copia o desenho para o canvas do A-Frame Assets
                ctx.clearRect(0, 0, paintCanvas.width, paintCanvas.height);
                ctx.drawImage(tempCanvas, 0, 0, paintCanvas.width, paintCanvas.height);
                currentArtTexture = paintCanvas.toDataURL('image/png');
                
                // Limpa e esconde a UI de desenho
                document.body.removeChild(tempCanvas);
                drawingUI.classList.add('hidden');
                toggleDrawBtn.classList.remove('hidden');
                reticle.setAttribute('visible', true);
            };
        });
        
        // --- L√ìGICA DE POSICIONAMENTO E SALVAMENTO ---
        sceneEl.addEventListener('click', () => {
            if (currentArtTexture && reticle.getAttribute('visible')) {
                const position = reticle.getAttribute('position');
                const rotation = reticle.getAttribute('rotation');
                placeAndSaveArt(currentArtTexture, position, rotation);
                currentArtTexture = null; // Reseta para n√£o colocar de novo
                reticle.setAttribute('visible', false); // Esconde o ret√≠culo
            }
        });

        function placeAndSaveArt(texture, position, rotation) {
            const plane = document.createElement('a-plane');
            plane.setAttribute('material', `src: ${texture}; transparent: true; shader: flat;`);
            plane.setAttribute('width', 1.5);
            plane.setAttribute('height', 1.5);
            plane.setAttribute('position', position);
            plane.setAttribute('rotation', rotation);
            sceneEl.appendChild(plane);

            const user = auth.currentUser;
            if (!user) return;

            // L√≥gica de salvamento no Firebase (minificada)
            const artData = {ownerUid: user.uid, texture, position, rotation, timestamp: firebase.firestore.FieldValue.serverTimestamp()};
            const savedArt = JSON.parse(localStorage.getItem('aframe_art') || '[]'); savedArt.push(artData); localStorage.setItem('aframe_art', JSON.stringify(savedArt)); // Backup local
            db.collection('arts-aframe').add(artData).then(() => console.log("Arte salva no Firebase")).catch(e => console.error("Erro ao salvar:", e));
        }

        function loadArts() {
            db.collection('arts-aframe').orderBy('timestamp', 'desc').limit(20).get().then(snap => {
                snap.forEach(doc => {
                    const data = doc.data();
                    const plane = document.createElement('a-plane');
                    plane.setAttribute('material', `src: ${data.texture}; transparent: true; shader: flat;`);
                    plane.setAttribute('width', 1.5);
                    plane.setAttribute('height', 1.5);
                    plane.setAttribute('position', data.position);
                    plane.setAttribute('rotation', data.rotation);
                    sceneEl.appendChild(plane);
                });
            });
        }
    });
    </script>
</body>
</html>
