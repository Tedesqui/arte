<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ARte no Mundo - Simplificado</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }

        /* Pop-up de desenho */
        #drawing-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }
        #drawing-panel {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        #paint-canvas { border: 1px solid #ccc; touch-action: none; }
        #toolbar { display: flex; gap: 15px; align-items: center; }
        .draw-btn { padding: 10px 20px; border-radius: 8px; border: none; color: white; cursor: pointer; }
        #confirm-draw-btn { background-color: #28a745; }
        #cancel-draw-btn { background-color: #dc3545; }
        #brush-size { width: 150px; }

        /* Bot√£o para abrir a tela de desenho */
        #open-draw-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #00aaff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 32px;
            line-height: 60px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,.4);
            cursor: pointer;
            z-index: 10001;
        }
    </style>
</head>

<body>
    <a-scene 
        id="ar-scene" 
        vr-mode-ui="enabled: false" 
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" 
        renderer="antialias: true; alpha: true"
    >
        <a-camera gps-new-camera="gpsMinDistance: 5; gpsMinAccuracy: 100;"></a-camera>
    </a-scene>

    <div id="ar-overlay">
        <button id="open-draw-btn">üñåÔ∏è</button>
        <div id="drawing-container">
            <div id="drawing-panel">
                <canvas id="paint-canvas" width="300" height="300"></canvas>
                <div id="toolbar">
                    <label for="color-picker">Cor:</label><input type="color" id="color-picker" value="#ff0000">
                    <label for="brush-size">Tamanho:</label><input type="range" id="brush-size" min="1" max="20" value="5">
                </div>
                <div>
                    <button id="confirm-draw-btn" class="draw-btn">Posicionar Arte</button>
                    <button id="cancel-draw-btn" class="draw-btn">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sceneEl = document.querySelector('a-scene');
            const openDrawBtn = document.getElementById('open-draw-btn');
            const drawingContainer = document.getElementById('drawing-container');
            const paintCanvas = document.getElementById('paint-canvas');
            const paintCtx = paintCanvas.getContext('2d');
            let isPainting = false;

            // --- L√≥gica de Desenho 2D ---
            function startPaint(e) { isPainting = true; draw(e); }
            function stopPaint() { isPainting = false; paintCtx.beginPath(); }
            function draw(e) {
                if (!isPainting) return;
                e.preventDefault();
                const rect = paintCanvas.getBoundingClientRect();
                const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
                const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
                paintCtx.lineWidth = document.getElementById('brush-size').value;
                paintCtx.lineCap = 'round';
                paintCtx.strokeStyle = document.getElementById('color-picker').value;
                paintCtx.lineTo(x, y);
                paintCtx.stroke();
                paintCtx.beginPath();
                paintCtx.moveTo(x, y);
            }
            paintCanvas.addEventListener('mousedown', startPaint);
            paintCanvas.addEventListener('mouseup', stopPaint);
            paintCanvas.addEventListener('mousemove', draw);
            paintCanvas.addEventListener('touchstart', startPaint, { passive: false });
            paintCanvas.addEventListener('touchend', stopPaint);
            paintCanvas.addEventListener('touchmove', draw, { passive: false });

            // --- Controles da UI ---
            openDrawBtn.addEventListener('click', () => {
                paintCtx.fillStyle = 'white';
                paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height); // Limpa com fundo branco
                drawingContainer.style.display = 'flex';
            });
            document.getElementById('cancel-draw-btn').addEventListener('click', () => {
                drawingContainer.style.display = 'none';
            });

            document.getElementById('confirm-draw-btn').addEventListener('click', () => {
                const textureData = paintCanvas.toDataURL();
                drawingContainer.style.display = 'none';
                
                console.log("Tentando obter GPS para salvar a arte...");
                navigator.geolocation.getCurrentPosition(position => {
                    console.log("GPS obtido:", position.coords);
                    placeAndSaveArt(textureData, position.coords.latitude, position.coords.longitude);
                }, (error) => {
                    console.error("Erro no GPS:", error);
                    alert('N√£o foi poss√≠vel obter a localiza√ß√£o para salvar. Por favor, verifique as permiss√µes e tente em um local aberto.');
                });
            });

            function placeAndSaveArt(textureData, latitude, longitude) {
                const artEntity = document.createElement('a-entity');
                artEntity.setAttribute('gps-new-entity-place', { latitude: latitude, longitude: longitude });
                
                const plane = document.createElement('a-plane');
                plane.setAttribute('material', { src: textureData, transparent: true, shader: 'flat' });
                plane.setAttribute('width', 2);
                plane.setAttribute('height', 2);
                plane.setAttribute('position', '0 1.6 -5'); // Posiciona √† frente da c√¢mera no momento da cria√ß√£o
                plane.setAttribute('look-at', '[gps-new-camera]'); // Faz a arte encarar o usu√°rio
                
                artEntity.appendChild(plane);
                sceneEl.appendChild(artEntity);

                const artData = {
                    gps: { lat: latitude, lon: longitude },
                    texture: textureData
                };
                
                const savedArt = JSON.parse(localStorage.getItem('simple_ar_art') || '[]');
                savedArt.push(artData);
                localStorage.setItem('simple_ar_art', JSON.stringify(savedArt));
                alert('Arte posicionada e salva no mundo!');
            }

            // Carrega artes salvas quando o GPS da c√¢mera est√° pronto
            sceneEl.camera.el.addEventListener('gps-camera-update-position', (e) => {
                const currentLat = e.detail.position.latitude;
                const currentLon = e.detail.position.longitude;
                
                // Limpa artes antigas para evitar duplicatas
                document.querySelectorAll('.saved-art').forEach(art => art.remove());

                const savedArt = JSON.parse(localStorage.getItem('simple_ar_art') || '[]');
                console.log(`Carregando ${savedArt.length} artes salvas.`);

                savedArt.forEach(artData => {
                    const dist = getDistance(currentLat, currentLon, artData.gps.lat, artData.gps.lon);
                    // Carrega apenas artes pr√≥ximas (raio de 5km)
                    if (dist < 5) { 
                        const artEntity = document.createElement('a-entity');
                        artEntity.setAttribute('gps-new-entity-place', { latitude: artData.gps.lat, longitude: artData.gps.lon });
                        artEntity.classList.add('saved-art');
                        
                        const plane = document.createElement('a-plane');
                        plane.setAttribute('material', { src: artData.texture, transparent: true, shader: 'flat' });
                        plane.setAttribute('width', 2);
                        plane.setAttribute('height', 2);
                        plane.setAttribute('position', '0 1.6 -5');
                        plane.setAttribute('look-at', '[gps-new-camera]');

                        artEntity.appendChild(plane);
                        sceneEl.appendChild(artEntity);
                    }
                });
            }, { once: true }); // Executa apenas uma vez para o carregamento inicial

            // Fun√ß√£o para calcular dist√¢ncia entre coordenadas GPS
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Raio da Terra em km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
        });
    </script>
</body>
</html>
