<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ARte no Mundo - Modo Grafite</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10002; color: white; text-align: center; }
        .spinner{border:8px solid #f3f3f3;border-top:8px solid #00aaff;border-radius:50%;width:60px;height:60px;animation:spin 1.5s linear infinite; margin-bottom: 20px;}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        
        #drawing-ui{display:none;position:fixed;top:0;left:0;width:100%;height:100%;flex-direction:column;z-index:10000}
        #drawing-canvas{position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;z-index:1}
        #toolbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,.7);padding:10px;border-radius:10px;display:flex;gap:15px;align-items:center;z-index:10}
        #drawing-controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:10}
        #toolbar label{font-size:14px;color:white}#toolbar input[type=color],#toolbar input[type=range]{vertical-align:middle}.draw-btn{padding:12px 20px;font-size:16px;font-weight:700;color:#fff;border:none;border-radius:25px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4)}#save-art-btn{background-color:#28a745}#cancel-draw-btn{background-color:#dc3545}#toggle-draw-mode-btn{position:fixed;bottom:20px;right:20px;background-color:#00aaff;color:#fff;border:none;border-radius:50%;width:60px;height:60px;font-size:32px;line-height:60px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.4);cursor:pointer;z-index:9999}
    </style>
</head>

<body>
    <div id="loader-container">
        <div class="spinner"></div>
        <p>Aponte o celular para o ambiente e mova-o lentamente para detectar as superf√≠cies.</p>
    </div>

    <div id="drawing-ui">
        <div id="toolbar">
            <label for="color-picker">Cor:</label><input type="color" id="color-picker" value="#FFFFFF">
            <label for="brush-size">Tamanho:</label><input type="range" id="brush-size" min="0.01" max="0.2" step="0.01" value="0.05">
        </div>
        <div id="drawing-controls">
            <button id="cancel-draw-btn" class="draw-btn">Sair</button>
        </div>
    </div>
    
    <button id="toggle-draw-mode-btn">üñåÔ∏è</button>

    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        renderer="colorManagement: true;"
    >
        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        window.addEventListener('load', () => {
            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('a-camera');
            const drawingUI = document.getElementById('drawing-ui');
            const loader = document.getElementById('loader-container');
            const toggleBtn = document.getElementById('toggle-draw-mode-btn');

            let isDrawing = false;
            let currentLine = null;
            let raycaster = new THREE.Raycaster();
            let pointer = new THREE.Vector2();

            scene.addEventListener('renderstart', () => loader.style.display = 'none');

            function startDraw(e) {
                isDrawing = true;
                // Cria uma nova entidade para a linha que ser√° desenhada
                currentLine = document.createElement('a-entity');
                // Adiciona o componente 'line' que ser√° preenchido com pontos
                currentLine.setAttribute('line', {
                    color: document.getElementById('color-picker').value,
                    linewidth: document.getElementById('brush-size').value * 200 // Ajuste para visualiza√ß√£o
                });
                scene.appendChild(currentLine);
            }

            function draw(e) {
                if (!isDrawing) return;

                // Normaliza as coordenadas do toque/mouse
                pointer.x = (e.clientX / window.innerWidth) * 2 - 1;
                pointer.y = -(e.clientY / window.innerHeight) * 2 + 1;

                // Atualiza o raycaster com a posi√ß√£o da c√¢mera e do ponteiro
                raycaster.setFromCamera(pointer, camera.object3D);
                
                // Calcula a posi√ß√£o no espa√ßo 3D, a 2 metros da c√¢mera
                // Isso simula o desenho em uma superf√≠cie pr√≥xima
                const pos = new THREE.Vector3();
                raycaster.ray.at(2, pos); // O n√∫mero '2' define a dist√¢ncia do desenho

                // Adiciona o novo ponto √† linha
                const lineAttr = currentLine.getAttribute('line');
                const newPath = lineAttr.path ? `${lineAttr.path}, ${pos.x} ${pos.y} ${pos.z}` : `${pos.x} ${pos.y} ${pos.z}`;
                
                currentLine.setAttribute('line', 'path', newPath);
                currentLine.setAttribute('line', 'color', document.getElementById('color-picker').value);
                currentLine.setAttribute('line', 'linewidth', document.getElementById('brush-size').value * 200);
            }

            function stopDraw() {
                isDrawing = false;
                currentLine = null;
            }

            // Ativar/Desativar modo de desenho
            toggleBtn.addEventListener('click', () => {
                drawingUI.style.display = 'flex';
                scene.addEventListener('mousedown', startDraw);
                scene.addEventListener('mousemove', draw);
                scene.addEventListener('mouseup', stopDraw);
                scene.addEventListener('touchstart', startDraw);
                scene.addEventListener('touchmove', draw);
                scene.addEventListener('touchend', stopDraw);
            });

            document.getElementById('cancel-draw-btn').addEventListener('click', () => {
                drawingUI.style.display = 'none';
                scene.removeEventListener('mousedown', startDraw);
                scene.removeEventListener('mousemove', draw);
                scene.removeEventListener('mouseup', stopDraw);
                scene.removeEventListener('touchstart', startDraw);
                scene.removeEventListener('touchmove', draw);
                scene.removeEventListener('touchend', stopDraw);
            });
        });

        // Script para remover o bot√£o de VR
        document.addEventListener('DOMContentLoaded',function(){const e=document.querySelector("a-scene");e&&e.addEventListener("loaded",function(){const t=document.querySelector(".a-enter-vr");t&&(t.style.display="none")})});
    </script>
</body>
</html>
