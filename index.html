<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ARte no Mundo - Grafite em Qualquer Superf√≠cie</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        
        #ar-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            font-size: 18px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            z-index: 10001;
        }

        /* A UI de desenho 2D agora √© um pop-up */
        #drawing-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }
        #drawing-panel {
            background-color: white;
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        #drawing-canvas { border: 1px solid #ccc; touch-action: none; }
        #toolbar { display: flex; gap: 10px; align-items: center; }
        .draw-btn { padding: 8px 16px; border-radius: 8px; border: none; color: white; cursor: pointer; }
        #confirm-draw-btn { background-color: #28a745; }
        #cancel-draw-btn { background-color: #dc3545; }
    </style>
</head>

<body>
    <a-scene 
        id="ar-scene"
        webxr="optionalFeatures: hit-test, plane-detection, dom-overlay; overlayElement: #ar-overlay;"
        ar-hit-test="target: #reticle;"
        renderer="colorManagement: true"
    >
        <a-assets>
            <canvas id="drawing-canvas" width="300" height="300"></canvas>
        </a-assets>

        <a-entity ar-plane-detection material="color: white; shader: flat; transparent: true; opacity: 0.25"></a-entity>
        
        <a-entity id="reticle" scale="0.8 0.8 0.8" visible="false">
             <a-ring color="#007aff" radius-inner="0.3" radius-outer="0.4"></a-ring>
        </a-entity>

    </a-scene>

    <div id="ar-overlay">
        <button id="ar-button">Iniciar AR</button>
        <div id="drawing-container">
            <div id="drawing-panel">
                <canvas id="paint-canvas" width="300" height="300"></canvas>
                <div id="toolbar">
                    <label for="color-picker">Cor:</label><input type="color" id="color-picker" value="#ff0000">
                    <label for="brush-size">Tamanho:</label><input type="range" id="brush-size" min="1" max="20" value="5">
                </div>
                <div>
                    <button id="confirm-draw-btn" class="draw-btn">Posicionar Arte</button>
                    <button id="cancel-draw-btn" class="draw-btn">Cancelar</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const sceneEl = document.querySelector('a-scene');
        const arButton = document.getElementById('ar-button');
        const drawingContainer = document.getElementById('drawing-container');
        const reticle = document.getElementById('reticle');
        
        let currentArtTexture = null;

        // --- L√≥gica principal de entrada em AR ---
        arButton.addEventListener('click', () => {
            sceneEl.enterAR();
        });

        sceneEl.addEventListener('enter-vr', () => {
            arButton.style.display = 'none';
            // Carrega artes salvas assim que a sess√£o AR come√ßa
            loadSavedArt();
        });
        
        sceneEl.addEventListener('exit-vr', () => {
            arButton.style.display = 'block';
        });

        // Mostra o ret√≠culo quando o hit-test encontra uma superf√≠cie
        sceneEl.addEventListener('ar-hit-test-start', () => reticle.setAttribute('visible', true));
        sceneEl.addEventListener('ar-hit-test-stop', () => reticle.setAttribute('visible', false));
        
        // --- L√≥gica de Desenho 2D ---
        const canvas = document.getElementById('paint-canvas');
        const ctx = canvas.getContext('2d');
        let isPainting = false;

        function startPaint(e) { isPainting = true; draw(e); }
        function stopPaint() { isPainting = false; ctx.beginPath(); }
        function draw(e) {
            if (!isPainting) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineWidth = document.getElementById('brush-size').value;
            ctx.lineCap = 'round';
            ctx.strokeStyle = document.getElementById('color-picker').value;
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        canvas.addEventListener('mousedown', startPaint);
        canvas.addEventListener('mouseup', stopPaint);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', startPaint);
        canvas.addEventListener('touchend', stopPaint);
        canvas.addEventListener('touchmove', draw);

        // --- L√≥gica da UI ---
        const openDrawBtn = document.createElement('button');
        openDrawBtn.textContent = 'üñåÔ∏è';
        openDrawBtn.style.cssText = `position: fixed; bottom: 20px; right: 20px; background-color: #00aaff; color: #fff; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 32px; line-height: 60px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,.4); cursor: pointer; z-index: 10001;`;
        document.body.appendChild(openDrawBtn);
        openDrawBtn.addEventListener('click', () => {
             ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpa o canvas
             drawingContainer.style.display = 'flex';
        });

        document.getElementById('cancel-draw-btn').addEventListener('click', () => drawingContainer.style.display = 'none');
        document.getElementById('confirm-draw-btn').addEventListener('click', () => {
            const dataURL = canvas.toDataURL();
            currentArtTexture = dataURL; // Armazena a arte desenhada
            drawingContainer.style.display = 'none';
            alert("Arte criada! Agora toque em uma superf√≠cie para posicion√°-la.");
        });

        // --- L√≥gica para Posicionar a Arte e Salvar ---
        sceneEl.addEventListener('click', (e) => {
            if (currentArtTexture && reticle.getAttribute('visible')) {
                placeAndSaveArt(currentArtTexture);
                currentArtTexture = null; // Reseta para n√£o posicionar de novo
            }
        });

        function placeAndSaveArt(textureData) {
             const plane = document.createElement('a-plane');
             plane.setAttribute('src', textureData);
             plane.setAttribute('width', 1);
             plane.setAttribute('height', 1);
             plane.setAttribute('rotation', reticle.object3D.rotation);
             plane.setAttribute('position', reticle.object3D.position);
             sceneEl.appendChild(plane);

             // Salvar com GPS
             navigator.geolocation.getCurrentPosition(position => {
                 const artData = {
                     gps: { lat: position.coords.latitude, lon: position.coords.longitude },
                     pos: reticle.object3D.position,
                     rot: { x: plane.object3D.rotation.x, y: plane.object3D.rotation.y, z: plane.object3D.rotation.z },
                     texture: textureData
                 };
                 const savedArt = JSON.parse(localStorage.getItem('webxr_art') || '[]');
                 savedArt.push(artData);
                 localStorage.setItem('webxr_art', JSON.stringify(savedArt));
                 alert('Arte posicionada e salva!');
             }, () => alert('N√£o foi poss√≠vel obter GPS para salvar a arte.'));
        }

        function loadSavedArt() {
            navigator.geolocation.getCurrentPosition(position => {
                 const currentLat = position.coords.latitude;
                 const currentLon = position.coords.longitude;
                 const savedArt = JSON.parse(localStorage.getItem('webxr_art') || '[]');

                 // Carrega apenas artes pr√≥ximas (dentro de um raio de ~5km)
                 const nearbyArt = savedArt.filter(art => {
                     const dist = getDistance(currentLat, currentLon, art.gps.lat, art.gps.lon);
                     return dist < 5; 
                 });

                 nearbyArt.forEach(artData => {
                     const plane = document.createElement('a-plane');
                     plane.setAttribute('src', artData.texture);
                     plane.setAttribute('width', 1);
                     plane.setAttribute('height', 1);
                     plane.setAttribute('position', artData.pos);
                     plane.setAttribute('rotation', artData.rot);
                     sceneEl.appendChild(plane);
                 });
            });
        }
        
        // Fun√ß√£o para calcular dist√¢ncia entre coordenadas GPS
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    });
    </script>
</body>
</html>
