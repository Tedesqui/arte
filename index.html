<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ARte no Mundo - Crie e Explore</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        
        /* --- CORREÇÃO 1: Painel de diagnóstico movido para o canto inferior esquerdo --- */
        #debug-panel {
            position: fixed;
            bottom: 10px; /* Alterado de 'top' para 'bottom' */
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.5;
            z-index: 10001; /* Z-index alto para ficar sobre a cena, mas abaixo da UI de desenho */
            max-width: 90%;
        }

        #loader-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #111; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10002;
        }
        .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid #00aaff;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos da UI de Desenho */
        #drawing-ui{display:none;position:fixed;top:0;left:0;width:100%;height:100%;flex-direction:column;background-color:rgba(0,0,0,.5);z-index:10000}
        
        /* A tela de desenho em si, fica no fundo */
        #drawing-canvas{position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none; z-index: 1;}
        
        /* --- CORREÇÃO 2: Barras de ferramentas com z-index para ficarem SOBRE o canvas --- */
        #toolbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,.7);padding:10px;border-radius:10px;display:flex;gap:15px;align-items:center; z-index: 10;}
        #drawing-controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:10px; z-index: 10;}

        /* Estilos restantes da UI */
        #toolbar label{font-size:14px;color:white}#toolbar input[type=color],#toolbar input[type=range]{vertical-align:middle}.draw-btn{padding:12px 20px;font-size:16px;font-weight:700;color:#fff;border:none;border-radius:25px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4)}#save-art-btn{background-color:#28a745}#cancel-draw-btn{background-color:#dc3545}#toggle-draw-mode-btn{position:fixed;bottom:20px;right:20px;background-color:#00aaff;color:#fff;border:none;border-radius:50%;width:60px;height:60px;font-size:24px;line-height:60px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.4);cursor:pointer;z-index:9999}
    </style>
</head>

<body>
    <div id="debug-panel">
        <strong>Status:</strong> <span id="debug-status">Iniciando...</span><br>
        <strong>Coords:</strong> <span id="debug-coords">N/A</span><br>
        <strong>Artes Carregadas:</strong> <span id="debug-art-loaded">Não</span>
    </div>

    <div id="loader-container"><div class="spinner"></div></div>

    <div id="drawing-ui">
        <div id="toolbar">
            <label for="color-picker">Cor:</label><input type="color" id="color-picker" value="#FFFFFF">
            <label for="brush-size">Tamanho:</label><input type="range" id="brush-size" min="1" max="20" value="5">
        </div>
        <canvas id="drawing-canvas"></canvas>
        <div id="drawing-controls">
            <button id="save-art-btn" class="draw-btn">Salvar Arte</button>
            <button id="cancel-draw-btn" class="draw-btn">Cancelar</button>
        </div>
    </div>
    <button id="toggle-draw-mode-btn">✏️</button>

    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="antialias: true; alpha: true"
    >
        <a-camera gps-new-camera="gpsMinDistance: 5; gpsMinAccuracy: 100;"></a-camera>
    </a-scene>

    <script>
        // SCRIPT PRINCIPAL DA APLICAÇÃO
        window.addEventListener('load', () => {
            const debugStatus = document.getElementById('debug-status');
            const debugCoords = document.getElementById('debug-coords');
            const debugArtLoaded = document.getElementById('debug-art-loaded');
            debugStatus.textContent = 'Aguardando GPS...';

            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('a-camera');
            let initialArtLoaded = false;
            let currentLatitude = null;
            let currentLongitude = null;

            scene.addEventListener('renderstart', () => {
                document.getElementById('loader-container').style.display = 'none';
            });

            camera.addEventListener('gps-camera-update-position', (event) => {
                currentLatitude = event.detail.position.latitude;
                currentLongitude = event.detail.position.longitude;
                debugStatus.textContent = 'GPS OK!';
                debugCoords.textContent = `${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}`;
                if (!initialArtLoaded) {
                    loadSavedArtworks();
                    initialArtLoaded = true;
                }
            });

            function loadSavedArtworks() { /* ...código sem alterações... */ }
            function addDrawingToScene(artwork) { /* ...código sem alterações... */ }
            
            function saveAndPlaceArt() {
                // --- CORREÇÃO 3: Mensagem de alerta mais clara ---
                if (!currentLatitude || !currentLongitude) {
                    alert("ERRO: GPS NÃO ENCONTRADO.\n\nPara salvar sua arte, o aplicativo precisa da sua localização exata.\n\nPor favor, vá para um local aberto, com visão clara do céu, e espere o status no canto da tela mudar para 'GPS OK!'.");
                    debugStatus.textContent = 'Falha ao salvar: GPS não encontrado.';
                    return;
                }
                const dataURL = canvas.toDataURL('image/png');
                if (dataURL.length < 200) {
                     alert('Desenhe algo antes de salvar!');
                     return;
                }
                const newDrawing = { latitude: currentLatitude, longitude: currentLongitude, dataURL: dataURL, width: canvas.width, height: canvas.height };
                addDrawingToScene(newDrawing);
                const savedDrawings = JSON.parse(localStorage.getItem('userDrawings') || '[]');
                savedDrawings.push(newDrawing);
                localStorage.setItem('userDrawings', JSON.stringify(savedDrawings));
                alert(`Arte salva em: ${currentLatitude.toFixed(4)}, ${currentLongitude.toFixed(4)}`);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawingUI.style.display = 'none';
                loadSavedArtworks();
            }

            // Lógica da UI de Desenho e funções auxiliares (sem alterações, apenas para completar)
            const drawingUI=document.getElementById("drawing-ui"),canvas=document.getElementById("drawing-canvas"),ctx=canvas.getContext("2d");let isDrawing=!1;const setupDrawingCanvas=()=>{canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.strokeStyle=document.getElementById("color-picker").value,ctx.lineWidth=document.getElementById("brush-size").value,ctx.lineCap="round",ctx.lineJoin="round"},startDrawing=e=>{isDrawing=!0;const t=getMousePos(e);ctx.beginPath(),ctx.moveTo(t.x,t.y)},draw=e=>{isDrawing&&(e.preventDefault(),e.stopPropagation(),ctx.lineTo(getMousePos(e).x,getMousePos(e).y),ctx.stroke())},stopDrawing=()=>{isDrawing=!1,ctx.closePath()},getMousePos=e=>{const t=canvas.getBoundingClientRect(),o=e.clientX||e.touches[0].clientX,n=e.clientY||e.touches[0].clientY;return{x:o-t.left,y:n-t.top}};
            loadSavedArtworks=function(){const e=JSON.parse(localStorage.getItem("userDrawings")||"[]");debugArtLoaded.textContent="Não",e.length>0?(e.forEach(addDrawingToScene),debugArtLoaded.textContent=`Sim (${e.length})`):debugArtLoaded.textContent="Nenhuma arte salva."},addDrawingToScene=function(e){const t=document.createElement("a-entity");t.setAttribute("gps-new-entity-place",{latitude:e.latitude,longitude:e.longitude});const o=document.createElement("a-plane");o.setAttribute("look-at","[gps-new-camera]"),o.setAttribute("material",`src: ${e.dataURL}; transparent: true; shader: flat;`);const n=15,a=e.width/e.height||1;o.setAttribute("scale",`${n*a} ${n} 1`),o.setAttribute("position","0 1.6 -10"),t.appendChild(o),scene.appendChild(t)};
            document.getElementById("color-picker").onchange=e=>ctx.strokeStyle=e.target.value,document.getElementById("brush-size").oninput=e=>ctx.lineWidth=e.target.value,canvas.addEventListener("mousedown",startDrawing),canvas.addEventListener("mousemove",draw),canvas.addEventListener("mouseup",stopDrawing),canvas.addEventListener("mouseout",stopDrawing),canvas.addEventListener("touchstart",startDrawing,{passive:!1}),canvas.addEventListener("touchmove",draw,{passive:!1}),canvas.addEventListener("touchend",stopDrawing);
            document.getElementById('toggle-draw-mode-btn').addEventListener('click', () => { drawingUI.style.display = 'flex'; setupDrawingCanvas(); });
            document.getElementById('cancel-draw-btn').addEventListener('click', () => { ctx.clearRect(0, 0, canvas.width, canvas.height); drawingUI.style.display = 'none'; });
            document.getElementById('save-art-btn').addEventListener('click', saveAndPlaceArt);
        });

        // SCRIPT EXTRA para remover botão de VR (mantido por segurança)
        document.addEventListener('DOMContentLoaded',function(){const e=document.querySelector("a-scene");e.addEventListener("loaded",function(){const t=document.querySelector(".a-enter-vr");t&&(t.style.display="none")})});
    </script>

</body>
</html>
